# 多级代理

有时候我们会希望一个连接经过多个代理服务器:

```
+---------+   +--------------+   +--------------+   +--------------+   +----------+
| User ->-+---+-> Proxy 1 ->-+---+-> Proxy 2 ->-+---+-> Proxy 3 ->-+---+-> Server |
+---------+   +--------------+   +--------------+   +--------------+   +----------+
```

图中的 Proxy 2 和 Proxy 3 可能都是「纯的」代理服务器: 它们只知道接受 socks5 请求, 并按照请求建立 tcp 连接, 不会进行代理中转。

因此, 在 Proxy 1 中, 当接到一个连接请求, 需要先让 Proxy 2 发起一个向 Proxy 3 的连接请求; 在这个连接建立之后, 再在这个连接中向 Proxy 3 发起一个对 Server 的连接请求。

换种表达方式:

- User → P1: 帮我连一下 Server。
- P1 → P2: 帮我连一下 P3。
- P2 → P1: 好, 连上了。接下来的消息我会转给 P3。
- P1 → P2: 帮我连一下 Server。
- P2 → P3 (无情的消息转发机器人): 帮我连一下 Server。
- P3 → P2: 好, 连上了。接下来的消息我会转给 Server。
- P2 → P1 (无情的消息转发机器人): 好, 连上了。接下来的消息我会转给 Server。
- P1 → User: 好, 连上了。接下来的消息我会转给 Server。

如果再加一级代理:

- User → P1: 帮我连一下 Server。
- P1 → P2: 帮我连一下 P3。
- P2 → P1: 好, 连上了。接下来的消息我会转给 P3。
- P1 → P2: 帮我连一下 P4。
- P2 → P3 (无情的消息转发机器人): 帮我连一下 P4。
- P3 → P2: 好, 连上了。接下来的消息我会转给 P4。
- P2 → P1 (无情的消息转发机器人): 好, 连上了。接下来的消息我会转给 P4。
- P1 → P2: 帮我连一下 Server。
- P2 → P3 (无情的消息转发机器人): 帮我连一下 Server。
- P3 → P4 (无情的消息转发机器人): 帮我连一下 Server。
- P4 → P3: 好, 连上了。接下来的消息我会转给 Server。
- P3 → P2 (无情的消息转发机器人): 好, 连上了。接下来的消息我会转给 Server。
- P2 → P1 (无情的消息转发机器人): 好, 连上了。接下来的消息我会转给 Server。
- P1 → User: 好, 连上了。接下来的消息我会转给 Server。
